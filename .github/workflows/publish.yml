name: publish to PyPI

on:
  workflow_run:
    workflows: ["Python Code Quality"]   # must match the 'name:' in code-quality.yml
    types: [completed]

jobs:
  publish-to-pypi:
    # only run if the triggering run succeeded AND it was a tag push like v1.2.3
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push' &&
      startsWith(github.event.workflow_run.ref, 'refs/tags/v')

    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v4
        with:
          # build the exact commit that the quality workflow ran on
          ref: ${{ github.event.workflow_run.head_sha }}

      - uses: ./.github/actions/setup
      - run: uv build
      - run: ls -lah dist
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1